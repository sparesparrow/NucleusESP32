name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Quality checks and linting
  quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Run pre-commit hooks
      run: |
        pre-commit run --all-files

    - name: Run static analysis
      run: |
        python scripts/run-analysis.sh

  # Cross-platform testing
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Install test dependencies
      run: |
        pip install -r requirements-dev.txt

    - name: Run unit tests
      run: |
        pytest test/ -v --cov=nucleus --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # ESP32 firmware build
  build-esp32:
    runs-on: ubuntu-latest
    container: espressif/idf:latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Install ESP32 toolchain
      run: |
        pip install platformio

    - name: Build ESP32 firmware
      run: |
        platformio run -e esp32dev

    - name: Build different ESP32 variants
      run: |
        # Build for different board configurations
        platformio run -e esp32-2432S028R
        platformio run -e esp32-8048S043C

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esp32-firmware
        path: |
          .pio/build/*/firmware.bin
          .pio/build/*/partitions.bin
          .pio/build/*/bootloader.bin

  # Security scanning
  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Integration testing
  integration:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Run integration tests
      run: |
        pytest test/integration/ -v --tb=short

    - name: Run hardware simulation tests
      run: |
        python test/micropython.py

  # Deploy to staging (on main branch)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32, security, integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging

    steps:
    - uses: actions/checkout@v4

    - name: Download firmware artifacts
      uses: actions/download-artifact@v3
      with:
        name: esp32-firmware

    - name: Deploy to staging environment
      run: |
        echo "Deploying firmware to staging..."
        # Add deployment logic here
        # This could involve uploading to a firmware server,
        # updating documentation, etc.

  # Release (on tags)
  release:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32, security, integration]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download firmware artifacts
      uses: actions/download-artifact@v3
      with:
        name: esp32-firmware

    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes
          See changelog for details.

          ## Firmware Downloads
          - Download the appropriate firmware.bin for your ESP32 board
          - Use esptool.py to flash the firmware

    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./firmware.bin
        asset_name: nucleus-esp32-${{ github.ref_name }}.bin
        asset_content_type: application/octet-stream
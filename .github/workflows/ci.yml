name: NucleusESP32 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_full_matrix:
        description: 'Run full ESP32 board matrix (slower)'
        required: false
        default: false
        type: boolean
      skip_security:
        description: 'Skip security scanning'
        required: false
        default: false
        type: boolean

env:
  SPARETOOLS_PROJECT_TYPE: embedded/esp32
  SPARETOOLS_PROJECT_NAME: nucleus-esp32
  CONAN_USER_HOME: ${{ github.workspace }}/.conan-cache

jobs:
  # Quality checks
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Bootstrap development environment (includes bundled CPython)
      run: python scripts/bootstrap.py

    - name: Set up Python path (use bundled CPython)
      run: |
        # Add bundled Python to PATH if available
        if [ -f ".venv/bin/python" ]; then
          echo ".venv/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from virtual environment"
        elif [ -f ".conan/sparetools-cpython/3.12.7/bin/python3" ]; then
          echo ".conan/sparetools-cpython/3.12.7/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from Conan"
        else
          echo "Bundled CPython not found, using system Python"
        fi

    - name: Verify bundled Python usage
      run: |
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        python -c "import sys; print(f'Python path: {sys.executable}')" 

    - name: Run pre-commit hooks
      run: |
        pre-commit run --all-files --show-diff-on-failure

    - name: Run static analysis
      run: |
        python -m mypy src/ test_harness/ scripts/ --ignore-missing-imports
        python -m flake8 src/ test_harness/ scripts/
        python -m black --check --diff src/ test_harness/ scripts/

  # Unit and integration testing
  test:
    name: Test Suite (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        test-suite: [unit, integration]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Bootstrap development environment (includes bundled CPython)
      run: python scripts/bootstrap.py

    - name: Set up Python path (use bundled CPython)
      run: |
        # Add bundled Python to PATH if available
        if [ -f ".venv/bin/python" ]; then
          echo ".venv/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from virtual environment"
        elif [ -f ".conan/sparetools-cpython/3.12.7/bin/python3" ]; then
          echo ".conan/sparetools-cpython/3.12.7/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from Conan"
        else
          echo "Bundled CPython not found, using system Python"
        fi

    - name: Verify bundled Python usage
      run: |
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        python -c "import sys; print(f'Python path: {sys.executable}')" 

    - name: Run unit tests
      if: matrix.test-suite == 'unit'
      run: |
        mkdir -p build-release
        cd build-release
        cmake .. -DCMAKE_BUILD_TYPE=Debug
        make -j$(nproc)
        ctest --output-on-failure --output-junit ../test-results/unit_tests.xml

    - name: Run integration tests
      if: matrix.test-suite == 'integration'
      run: |
        python scripts/test_runner.py --integration-only --report-dir ./test-results

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.test-suite }}
        path: test-results/
        retention-days: 7

  # ESP32 firmware builds
  build-esp32:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        board: ${{ fromJson(inputs.run_full_matrix && '["esp32dev", "esp32-s3-devkitc-1", "esp32-c3-devkitc-02"]' || '["esp32dev"]') }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Bootstrap development environment (includes bundled CPython)
      run: python scripts/bootstrap.py

    - name: Set up Python path (use bundled CPython)
      run: |
        # Add bundled Python to PATH if available
        if [ -f ".venv/bin/python" ]; then
          echo ".venv/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from virtual environment"
        elif [ -f ".conan/sparetools-cpython/3.12.7/bin/python3" ]; then
          echo ".conan/sparetools-cpython/3.12.7/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from Conan"
        else
          echo "Bundled CPython not found, using system Python"
        fi

    - name: Verify bundled Python usage
      run: |
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        python -c "import sys; print(f'Python path: {sys.executable}')" 

    - name: Install ESP32 PlatformIO platform
      run: |
        pio platform install espressif32 --with-package framework-arduinoespressif32

    - name: Build ESP32 firmware (${{ matrix.board }})
      run: |
        pio run -e ${{ matrix.board }}

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esp32-firmware-${{ matrix.board }}
        path: |
          .pio/build/${{ matrix.board }}/firmware.bin
          .pio/build/${{ matrix.board }}/partitions.bin
          .pio/build/${{ matrix.board }}/bootloader.bin
        retention-days: 30

  # Security scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: quality
    if: inputs.skip_security != true
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Bootstrap development environment (includes bundled CPython)
      run: python scripts/bootstrap.py

    - name: Set up Python path (use bundled CPython)
      run: |
        # Add bundled Python to PATH if available
        if [ -f ".venv/bin/python" ]; then
          echo ".venv/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from virtual environment"
        elif [ -f ".conan/sparetools-cpython/3.12.7/bin/python3" ]; then
          echo ".conan/sparetools-cpython/3.12.7/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from Conan"
        else
          echo "Bundled CPython not found, using system Python"
        fi

    - name: Verify bundled Python usage
      run: |
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        python -c "import sys; print(f'Python path: {sys.executable}')" 

    - name: Install security tools
      run: |
        pip install cyclonedx-bom

    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'HIGH,CRITICAL'

    - name: Generate SBOM
      run: |
        cyclonedx-bom -o sbom.json -j -t poetry .

    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: trivy-results.sarif

    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: security-sbom
        path: sbom.json
        retention-days: 90

  # Integration testing (full suite on main branch)
  integration-full:
    name: Integration Test Suite (Full)
    runs-on: ubuntu-latest
    needs: [test, build-esp32]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ${{ env.CONAN_USER_HOME }}
        key: ${{ runner.os }}-conan-${{ hashFiles('conanfile.py') }}
        restore-keys: |
          ${{ runner.os }}-conan-

    - name: Bootstrap development environment
      run: python scripts/bootstrap.py

    - name: Install test dependencies
      run: |
        pip install -r requirements-dev.txt

    - name: Build C++ tests
      run: |
        mkdir -p build-release
        cd build-release
        cmake .. -DCMAKE_BUILD_TYPE=Debug
        make -j$(nproc)

    - name: Run unit tests
      run: |
        cd build-release
        ctest --output-on-failure --output-junit ../test-results/unit_tests.xml

    - name: Run integration tests
      env:
        NUCLEUS_HARDWARE_SIMULATION: true
        NUCLEUS_TEST_RESULTS_DIR: ${{ github.workspace }}/test-results
        PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}/test:${{ github.workspace }}/test_harness
      run: |
        python scripts/test_runner.py --integration-only --report-dir ./test-results

    - name: Run hardware simulation tests
      run: |
        python test_harness/demo.py

    - name: Generate coverage report
      run: |
        python scripts/test_runner.py --coverage --report-dir ./coverage-results

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-full
        path: |
          test-results/
          coverage-results/
        retention-days: 7

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage-results/coverage.xml
        flags: full-suite
        name: codecov-full
        fail_ci_if_error: false

  # Performance regression testing
  performance:
    runs-on: ubuntu-latest
    needs: [test, build-esp32]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Bootstrap development environment (includes bundled CPython)
      run: python scripts/bootstrap.py

    - name: Set up Python path (use bundled CPython)
      run: |
        # Add bundled Python to PATH if available
        if [ -f ".venv/bin/python" ]; then
          echo ".venv/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from virtual environment"
        elif [ -f ".conan/sparetools-cpython/3.12.7/bin/python3" ]; then
          echo ".conan/sparetools-cpython/3.12.7/bin" >> $GITHUB_PATH
          echo "Using bundled CPython from Conan"
        else
          echo "Bundled CPython not found, using system Python"
        fi

    - name: Verify bundled Python usage
      run: |
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        python -c "import sys; print(f'Python path: {sys.executable}')" 

    - name: Run performance benchmarks
      run: |
        python scripts/test_runner.py --integration-only --report-dir ./perf-results

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: perf-results/
        retention-days: 90

  # Deploy to staging (on main branch)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [integration-full, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download firmware artifacts
      uses: actions/download-artifact@v3
      with:
        name: esp32-firmware-esp32dev
        path: ./firmware

    - name: Deploy to staging environment
      run: |
        echo "ðŸš€ Deploying NucleusESP32 firmware to staging..."

        # Verify firmware files exist
        ls -la firmware/

        # Placeholder for staging deployment
        # In a real implementation, this would:
        # - Upload firmware to a staging firmware server
        # - Update staging documentation
        # - Trigger integration tests in staging environment
        # - Send notifications to stakeholders

        echo "âœ… Staging deployment completed"
        echo "Firmware available at: https://staging.firmware.nucleus-esp32.com/"

    - name: Notify stakeholders
      run: |
        # Placeholder for notifications
        # This could send Slack messages, emails, etc.
        echo "ðŸ“¢ Staging deployment notification sent"

  # Cross-platform testing
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Install test dependencies
      run: |
        pip install -r requirements-dev.txt

    - name: Run unit tests
      run: |
        pytest test/ -v --cov=nucleus --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # ESP32 firmware build
  build-esp32:
    runs-on: ubuntu-latest
    container: espressif/idf:latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Install ESP32 toolchain
      run: |
        pip install platformio

    - name: Build ESP32 firmware
      run: |
        platformio run -e esp32dev

    - name: Build different ESP32 variants
      run: |
        # Build for different board configurations
        platformio run -e esp32-2432S028R
        platformio run -e esp32-8048S043C

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esp32-firmware
        path: |
          .pio/build/*/firmware.bin
          .pio/build/*/partitions.bin
          .pio/build/*/bootloader.bin

  # Security scanning
  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Integration testing
  integration:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: |
        python scripts/bootstrap.py

    - name: Run integration tests
      run: |
        pytest test/integration/ -v --tb=short

    - name: Run hardware simulation tests
      run: |
        python test/micropython.py

  # Deploy to staging (on main branch)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32, security, integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging

    steps:
    - uses: actions/checkout@v4

    - name: Download firmware artifacts
      uses: actions/download-artifact@v3
      with:
        name: esp32-firmware

    - name: Deploy to staging environment
      run: |
        echo "Deploying firmware to staging..."
        # Add deployment logic here
        # This could involve uploading to a firmware server,
        # updating documentation, etc.

  # Release (on tags)
  release:
    runs-on: ubuntu-latest
    needs: [quality, test, build-esp32, security, integration]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download firmware artifacts
      uses: actions/download-artifact@v3
      with:
        name: esp32-firmware

    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes
          See changelog for details.

          ## Firmware Downloads
          - Download the appropriate firmware.bin for your ESP32 board
          - Use esptool.py to flash the firmware

    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./firmware.bin
        asset_name: nucleus-esp32-${{ github.ref_name }}.bin
        asset_content_type: application/octet-stream
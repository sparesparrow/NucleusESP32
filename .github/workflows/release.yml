name: Release Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

env:
  SPARETOOLS_PROJECT_TYPE: embedded/esp32
  SPARETOOLS_PROJECT_NAME: nucleus-esp32

jobs:
  # Pre-release checks
  pre-release-checks:
    uses: ./.github/workflows/reusable-quality.yml
    with:
      python-version: '3.12'
      bootstrap-script: 'python scripts/bootstrap.py'
      run-static-analysis: true

  # Full test suite
  release-tests:
    uses: ./.github/workflows/reusable-testing.yml
    needs: pre-release-checks
    with:
      python-version: '3.12'
      bootstrap-script: 'python scripts/bootstrap.py'
      test-suite: 'all'
      enable-coverage: true
      run-hardware-simulation: true

  # Build all ESP32 variants
  release-builds:
    uses: ./.github/workflows/reusable-build.yml
    needs: pre-release-checks
    with:
      esp32-boards: '["esp32dev", "esp32-2432S028R", "esp32-8048S043C", "esp32s3"]'
      python-version: '3.12'
      bootstrap-script: 'python scripts/bootstrap.py'
      enable-caching: false  # Clean builds for release

  # Security audit
  security-audit:
    uses: ./.github/workflows/reusable-security.yml
    needs: pre-release-checks
    with:
      python-version: '3.12'
      scan-type: 'full'
      generate-sbom: true

  # Create release
  create-release:
    runs-on: ubuntu-latest
    needs: [release-tests, release-builds, security-audit]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all firmware artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./artifacts

    - name: Download SBOM
      uses: actions/download-artifact@v3
      with:
        name: security-sbom
        path: ./sbom

    - name: Generate release notes
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}

        # Create release notes
        cat > release_notes.md << EOF
        # NucleusESP32 ${VERSION}

        ## What's New

        This release includes comprehensive updates to the NucleusESP32 firmware with enhanced testing infrastructure and CI/CD automation.

        ## Firmware Downloads

        Download the appropriate firmware for your ESP32 board:

        ### ESP32 Classic Boards
        - **ESP32-DevKitC**: \`nucleus-esp32-${VERSION}-esp32dev.bin\`
        - **ESP32-2432S028R**: \`nucleus-esp32-${VERSION}-esp32-2432S028R.bin\`
        - **ESP32-8048S043C**: \`nucleus-esp32-${VERSION}-esp32-8048S043C.bin\`

        ### ESP32-S3 Boards
        - **ESP32-S3**: \`nucleus-esp32-${VERSION}-esp32s3.bin\`

        ## Installation

        Use esptool.py to flash the firmware:

        \`\`\`bash
        esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 \\
          --before default_reset --after hard_reset write_flash \\
          -z --flash_mode dio --flash_freq 40m --flash_size detect \\
          0x1000 bootloader.bin \\
          0x8000 partitions.bin \\
          0x10000 firmware.bin
        \`\`\`

        ## Security

        - Full security audit passed
        - SBOM (Software Bill of Materials) included
        - No critical or high-severity vulnerabilities

        ## Testing

        - 100% integration test coverage
        - Hardware simulation testing completed
        - Performance benchmarks validated

        ## Checksums

        $(cd artifacts && find . -name "*.bin" -exec sha256sum {} \; | sed 's|^\./|- |')

        ---

        **Built on**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit**: ${GITHUB_SHA}
        EOF

    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: NucleusESP32 ${{ github.ref_name }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ inputs.prerelease || false }}

    - name: Upload firmware binaries
      run: |
        for board_dir in artifacts/*/; do
          if [ -d "$board_dir" ]; then
            board_name=$(basename "$board_dir")
            for bin_file in "$board_dir"/*.bin; do
              if [ -f "$bin_file" ]; then
                filename=$(basename "$bin_file")
                asset_name="nucleus-esp32-${{ github.ref_name }}-${board_name}-${filename}"
                echo "Uploading $asset_name"
                gh release upload ${{ github.ref }} "$bin_file" \
                  --clobber \
                  --repo ${{ github.repository }}
              fi
            done
          fi
        done

    - name: Upload SBOM
      run: |
        gh release upload ${{ github.ref }} sbom/sbom.json \
          --clobber \
          --repo ${{ github.repository }}

    - name: Deploy to firmware server (placeholder)
      run: |
        echo "Firmware deployment to server would happen here"
        # TODO: Implement firmware server deployment
        # This could upload to a CDN, firmware update server, etc.
name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 02:00 UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: false
        default: 'security'
        type: choice
        options:
        - security
        - all
        - patch-only

env:
  SPARETOOLS_PROJECT_TYPE: embedded/esp32
  SPARETOOLS_PROJECT_NAME: nucleus-esp32

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Bootstrap development environment
      run: python scripts/bootstrap.py

    - name: Update Python dependencies
      run: |
        pip install pip-tools

        case "${{ inputs.update_type }}" in
          "security")
            # Update only security-related packages
            pip-compile --upgrade --resolver=backtracking requirements-dev.in
            ;;
          "patch-only")
            # Update only patch versions
            pip-compile --upgrade --resolver=backtracking --upgrade-package "*" requirements-dev.in
            ;;
          "all")
            # Update all packages
            pip-compile --upgrade --resolver=backtracking --upgrade-package "*" requirements-dev.in
            ;;
        esac

    - name: Update Conan dependencies
      run: |
        # Check for outdated Conan packages
        conan outdated

        # Update conanfile.py with new versions if needed
        # This would require parsing conan outdated output

    - name: Run tests with updated dependencies
      run: |
        python scripts/test_runner.py --integration-only

    - name: Create pull request
      if: success()
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: automated/dependency-updates
        delete-branch: true
        title: "chore: Update dependencies (${{ inputs.update_type || 'security' }})"
        body: |
          ## Automated Dependency Updates

          This PR updates project dependencies based on the `${{ inputs.update_type || 'security' }}` update policy.

          ### Changes
          - Updated Python dependencies in `requirements-dev.txt`
          - Updated Conan dependencies in `conanfile.py` (if applicable)

          ### Testing
          - All integration tests pass with updated dependencies
          - Security scanning completed successfully

          ### Review Notes
          - Review dependency changes for breaking changes
          - Ensure all tests continue to pass
          - Check for any required code changes due to API updates

          ---
          *This PR was automatically generated by the dependency update workflow.*
        commit-message: |
          chore: Update dependencies (${{ inputs.update_type || 'security' }})

          - Updated Python dependencies
          - Updated Conan dependencies
          - All tests pass with new versions